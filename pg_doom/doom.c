#include <stdint.h>
#include <stdlib.h>
#include "doom.h"

#include "d_main.h"
#include "doomstat.h"
#include "i_net.h"
#include "i_system.h"
#include "m_argv.h"
#include "m_misc.h"
#include "sounds.h"
#include "v_video.h"

extern int key_right;
extern int key_left;
extern int key_up;
extern int key_down;
extern int key_strafeleft;
extern int key_straferight;
extern int key_fire;
extern int key_use;
extern int key_strafe;
extern int key_speed;
extern int mousebfire;
extern int mousebstrafe;
extern int mousebforward;
extern int joybfire;
extern int joybstrafe;
extern int joybuse;
extern int joybspeed;
extern int viewwidth;
extern int viewheight;
extern int mouseSensitivity;
extern int showMessages;
extern int detailLevel;
extern int screenblocks;
extern int showMessages;
extern int numChannels;

#define WIDTH  320
#define HEIGHT 200
static uint8_t   screen[WIDTH * HEIGHT];
static char*     palette[256];

#define NKEYS 6
static int     keyPressed[NKEYS];
static uint8_t keyDown[NKEYS];
static uint8_t keyCodes[NKEYS] = {KEY_LEFTARROW, KEY_RIGHTARROW, KEY_UPARROW, KEY_DOWNARROW, KEY_RCTRL, ' ' };


static char hex( int v ){
	return (v<10) ? '0' + v : 'A' + v - 10;
}

void I_InitSound( void ){
}

void I_UpdateSound( void ){
}

void I_SubmitSound( void ){
}

void I_ShutdownSound( void ){
}

void I_SetChannels( void ){
}

int I_GetSfxLumpNum( sfxinfo_t* sfxinfo ){
	return -1;
}

int I_StartSound( int id, int vol, int sep, int pitch, int priority ){
	return 0;
}

void I_StopSound( int handle ){
}

int I_SoundIsPlaying( int handle ){
	return 0;
}

void I_UpdateSoundParams( int handle, int vol, int sep, int pitch ){
}

void I_InitMusic( void ){
}

void I_ShutdownMusic( void ){
}

void I_SetMusicVolume( int volume ){
}

void I_PauseSong( int handle ){
}

void I_ResumeSong( int handle ){
}

int I_RegisterSong( void* data ){
	return 1;
}

void I_PlaySong( int handle, int looping ){
}

void I_StopSong( int handle ){
}

void I_UnRegisterSong( int handle ){
}

// void I_SubmitSoundData( void* data , int size ){
//    gdoom->p->sound->write( (char const*)data , size );
//}

void M_LoadDefaults( ){
	key_left         = KEY_LEFTARROW;
	key_right        = KEY_RIGHTARROW;
	key_up           = KEY_UPARROW;
	key_down         = KEY_DOWNARROW;
	key_strafeleft   = ',';
	key_straferight  = '.';
	key_fire         = KEY_RCTRL;
	key_use          = ' ';
	key_strafe       = KEY_RALT;
	key_speed        = KEY_RSHIFT;
	mousebfire       = 0;
	mousebstrafe     = 0;
	mousebforward    = 0;
	joybfire         = 0;
	joybstrafe       = 0;
	joybuse          = 0;
	joybspeed        = 0;
	mouseSensitivity = 5;
	showMessages     = 1;
	detailLevel      = 0;
	screenblocks     = 9;
	numChannels      = 2;
	snd_SfxVolume   = 15;
	snd_MusicVolume = 15;
}

void M_SaveDefaults( void ){
}

void I_InitGraphics( void ){
	screens[0] = screen;
}

void I_ShutdownGraphics( void ){
	exit(0);
}

void I_SetPalette( byte* p ){
	static uint8_t termColors[][3]={
		// {0, 0, 0},
		// {255, 0, 0},
		// {0, 255, 0},
		// {255, 255, 0},
		// {0, 0, 255},
		// {255, 0, 255},
		// {0, 255, 255},
		// {255, 255, 255},
		{0x00,0x00,0x00},
		{0x80,0x00,0x00},
		{0x00,0x80,0x00},
		{0x80,0x80,0x00},
		{0x00,0x00,0x80},
		{0x80,0x00,0x80},
		{0x00,0x80,0x80},
		{0xc0,0xc0,0xc0},
		{0x80,0x80,0x80},
		{0xff,0x00,0x00},
		{0x00,0xff,0x00},
		{0xff,0xff,0x00},
		{0x00,0x00,0xff},
		{0xff,0x00,0xff},
		{0x00,0xff,0xff},
		{0xff,0xff,0xff},
		{0x00,0x00,0x00},
		{0x00,0x00,0x5f},
		{0x00,0x00,0x87},
		{0x00,0x00,0xaf},
		{0x00,0x00,0xd7},
		{0x00,0x00,0xff},
		{0x00,0x5f,0x00},
		{0x00,0x5f,0x5f},
		{0x00,0x5f,0x87},
		{0x00,0x5f,0xaf},
		{0x00,0x5f,0xd7},
		{0x00,0x5f,0xff},
		{0x00,0x87,0x00},
		{0x00,0x87,0x5f},
		{0x00,0x87,0x87},
		{0x00,0x87,0xaf},
		{0x00,0x87,0xd7},
		{0x00,0x87,0xff},
		{0x00,0xaf,0x00},
		{0x00,0xaf,0x5f},
		{0x00,0xaf,0x87},
		{0x00,0xaf,0xaf},
		{0x00,0xaf,0xd7},
		{0x00,0xaf,0xff},
		{0x00,0xd7,0x00},
		{0x00,0xd7,0x5f},
		{0x00,0xd7,0x87},
		{0x00,0xd7,0xaf},
		{0x00,0xd7,0xd7},
		{0x00,0xd7,0xff},
		{0x00,0xff,0x00},
		{0x00,0xff,0x5f},
		{0x00,0xff,0x87},
		{0x00,0xff,0xaf},
		{0x00,0xff,0xd7},
		{0x00,0xff,0xff},
		{0x5f,0x00,0x00},
		{0x5f,0x00,0x5f},
		{0x5f,0x00,0x87},
		{0x5f,0x00,0xaf},
		{0x5f,0x00,0xd7},
		{0x5f,0x00,0xff},
		{0x5f,0x5f,0x00},
		{0x5f,0x5f,0x5f},
		{0x5f,0x5f,0x87},
		{0x5f,0x5f,0xaf},
		{0x5f,0x5f,0xd7},
		{0x5f,0x5f,0xff},
		{0x5f,0x87,0x00},
		{0x5f,0x87,0x5f},
		{0x5f,0x87,0x87},
		{0x5f,0x87,0xaf},
		{0x5f,0x87,0xd7},
		{0x5f,0x87,0xff},
		{0x5f,0xaf,0x00},
		{0x5f,0xaf,0x5f},
		{0x5f,0xaf,0x87},
		{0x5f,0xaf,0xaf},
		{0x5f,0xaf,0xd7},
		{0x5f,0xaf,0xff},
		{0x5f,0xd7,0x00},
		{0x5f,0xd7,0x5f},
		{0x5f,0xd7,0x87},
		{0x5f,0xd7,0xaf},
		{0x5f,0xd7,0xd7},
		{0x5f,0xd7,0xff},
		{0x5f,0xff,0x00},
		{0x5f,0xff,0x5f},
		{0x5f,0xff,0x87},
		{0x5f,0xff,0xaf},
		{0x5f,0xff,0xd7},
		{0x5f,0xff,0xff},
		{0x87,0x00,0x00},
		{0x87,0x00,0x5f},
		{0x87,0x00,0x87},
		{0x87,0x00,0xaf},
		{0x87,0x00,0xd7},
		{0x87,0x00,0xff},
		{0x87,0x5f,0x00},
		{0x87,0x5f,0x5f},
		{0x87,0x5f,0x87},
		{0x87,0x5f,0xaf},
		{0x87,0x5f,0xd7},
		{0x87,0x5f,0xff},
		{0x87,0x87,0x00},
		{0x87,0x87,0x5f},
		{0x87,0x87,0x87},
		{0x87,0x87,0xaf},
		{0x87,0x87,0xd7},
		{0x87,0x87,0xff},
		{0x87,0xaf,0x00},
		{0x87,0xaf,0x5f},
		{0x87,0xaf,0x87},
		{0x87,0xaf,0xaf},
		{0x87,0xaf,0xd7},
		{0x87,0xaf,0xff},
		{0x87,0xd7,0x00},
		{0x87,0xd7,0x5f},
		{0x87,0xd7,0x87},
		{0x87,0xd7,0xaf},
		{0x87,0xd7,0xd7},
		{0x87,0xd7,0xff},
		{0x87,0xff,0x00},
		{0x87,0xff,0x5f},
		{0x87,0xff,0x87},
		{0x87,0xff,0xaf},
		{0x87,0xff,0xd7},
		{0x87,0xff,0xff},
		{0xaf,0x00,0x00},
		{0xaf,0x00,0x5f},
		{0xaf,0x00,0x87},
		{0xaf,0x00,0xaf},
		{0xaf,0x00,0xd7},
		{0xaf,0x00,0xff},
		{0xaf,0x5f,0x00},
		{0xaf,0x5f,0x5f},
		{0xaf,0x5f,0x87},
		{0xaf,0x5f,0xaf},
		{0xaf,0x5f,0xd7},
		{0xaf,0x5f,0xff},
		{0xaf,0x87,0x00},
		{0xaf,0x87,0x5f},
		{0xaf,0x87,0x87},
		{0xaf,0x87,0xaf},
		{0xaf,0x87,0xd7},
		{0xaf,0x87,0xff},
		{0xaf,0xaf,0x00},
		{0xaf,0xaf,0x5f},
		{0xaf,0xaf,0x87},
		{0xaf,0xaf,0xaf},
		{0xaf,0xaf,0xd7},
		{0xaf,0xaf,0xff},
		{0xaf,0xd7,0x00},
		{0xaf,0xd7,0x5f},
		{0xaf,0xd7,0x87},
		{0xaf,0xd7,0xaf},
		{0xaf,0xd7,0xd7},
		{0xaf,0xd7,0xff},
		{0xaf,0xff,0x00},
		{0xaf,0xff,0x5f},
		{0xaf,0xff,0x87},
		{0xaf,0xff,0xaf},
		{0xaf,0xff,0xd7},
		{0xaf,0xff,0xff},
		{0xd7,0x00,0x00},
		{0xd7,0x00,0x5f},
		{0xd7,0x00,0x87},
		{0xd7,0x00,0xaf},
		{0xd7,0x00,0xd7},
		{0xd7,0x00,0xff},
		{0xd7,0x5f,0x00},
		{0xd7,0x5f,0x5f},
		{0xd7,0x5f,0x87},
		{0xd7,0x5f,0xaf},
		{0xd7,0x5f,0xd7},
		{0xd7,0x5f,0xff},
		{0xd7,0x87,0x00},
		{0xd7,0x87,0x5f},
		{0xd7,0x87,0x87},
		{0xd7,0x87,0xaf},
		{0xd7,0x87,0xd7},
		{0xd7,0x87,0xff},
		{0xd7,0xaf,0x00},
		{0xd7,0xaf,0x5f},
		{0xd7,0xaf,0x87},
		{0xd7,0xaf,0xaf},
		{0xd7,0xaf,0xd7},
		{0xd7,0xaf,0xff},
		{0xd7,0xd7,0x00},
		{0xd7,0xd7,0x5f},
		{0xd7,0xd7,0x87},
		{0xd7,0xd7,0xaf},
		{0xd7,0xd7,0xd7},
		{0xd7,0xd7,0xff},
		{0xd7,0xff,0x00},
		{0xd7,0xff,0x5f},
		{0xd7,0xff,0x87},
		{0xd7,0xff,0xaf},
		{0xd7,0xff,0xd7},
		{0xd7,0xff,0xff},
		{0xff,0x00,0x00},
		{0xff,0x00,0x5f},
		{0xff,0x00,0x87},
		{0xff,0x00,0xaf},
		{0xff,0x00,0xd7},
		{0xff,0x00,0xff},
		{0xff,0x5f,0x00},
		{0xff,0x5f,0x5f},
		{0xff,0x5f,0x87},
		{0xff,0x5f,0xaf},
		{0xff,0x5f,0xd7},
		{0xff,0x5f,0xff},
		{0xff,0x87,0x00},
		{0xff,0x87,0x5f},
		{0xff,0x87,0x87},
		{0xff,0x87,0xaf},
		{0xff,0x87,0xd7},
		{0xff,0x87,0xff},
		{0xff,0xaf,0x00},
		{0xff,0xaf,0x5f},
		{0xff,0xaf,0x87},
		{0xff,0xaf,0xaf},
		{0xff,0xaf,0xd7},
		{0xff,0xaf,0xff},
		{0xff,0xd7,0x00},
		{0xff,0xd7,0x5f},
		{0xff,0xd7,0x87},
		{0xff,0xd7,0xaf},
		{0xff,0xd7,0xd7},
		{0xff,0xd7,0xff},
		{0xff,0xff,0x00},
		{0xff,0xff,0x5f},
		{0xff,0xff,0x87},
		{0xff,0xff,0xaf},
		{0xff,0xff,0xd7},
		{0xff,0xff,0xff},
		{0x08,0x08,0x08},
		{0x12,0x12,0x12},
		{0x1c,0x1c,0x1c},
		{0x26,0x26,0x26},
		{0x30,0x30,0x30},
		{0x3a,0x3a,0x3a},
		{0x44,0x44,0x44},
		{0x4e,0x4e,0x4e},
		{0x58,0x58,0x58},
		{0x62,0x62,0x62},
		{0x6c,0x6c,0x6c},
		{0x76,0x76,0x76},
		{0x80,0x80,0x80},
		{0x8a,0x8a,0x8a},
		{0x94,0x94,0x94},
		{0x9e,0x9e,0x9e},
		{0xa8,0xa8,0xa8},
		{0xb2,0xb2,0xb2},
		{0xbc,0xbc,0xbc},
		{0xc6,0xc6,0xc6},
		{0xd0,0xd0,0xd0},
		{0xda,0xda,0xda},
		{0xe4,0xe4,0xe4},
		{0xee,0xee,0xee},
	};

	// static char charsByLuminosity[] = "$@B%8&WM#*oahkbdpqwmZO0QLCJUYXzcvunxrjft/\\|()1{}[]?-_+~<>i!lI;:,\"^`'. ";
	static char charsByOpacity[] = " .'`^\",:;Il!i><~+_-?][}{1)(|\/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$";

	for( int c = 0; c < 256; c++ ) {
		uint8_t r = gammatable[usegamma][*p++];
		uint8_t g = gammatable[usegamma][*p++];
		uint8_t b = gammatable[usegamma][*p++];

		if( palette[c] ){
			free(palette[c]);
		}

		int bestIndex = -1;
		int bestDist  = 0;
		for(int index=0; index < sizeof(termColors)/sizeof(termColors[0]); index++ ){
			int dr = termColors[index][0] - r;
			int dg = termColors[index][1] - g;
			int db = termColors[index][2] - b;

			int dist = dr*dr + dg*dg + db*db;
			if( bestIndex < 0 || dist < bestDist ){
				bestIndex = index;
				bestDist  = dist;
			}
		}

		uint32_t index = (0.2126*r + 0.7152*g + 0.0722*b) * (sizeof(charsByOpacity)-1) / 255;
		if( index >= sizeof(charsByOpacity) ){
			index = sizeof(charsByOpacity)-1;
		}

		char buf[256];
		sprintf(buf, "%c[38;5;%.2dm%c", 0x1B, bestIndex, charsByOpacity[index]);	
		palette[c] = strdup(buf);
	}
}

void I_StartTic( void ){
	for( int i=0 ;i < NKEYS; i++){

		if( keyPressed[i] ){
			keyPressed[i]--;
		}

		char down = (keyPressed[i]>0);
		if( down != keyDown[i] ){
			event_t n;
			n.type  = down ? ev_keydown : ev_keyup;
			n.data1 = keyCodes[i];
			D_PostEvent( &n );

			keyDown[i] = down;
		}
	}
}

void I_StartFrame( void ){
}

void I_UpdateNoBlit( void ){
}

void I_FinishUpdate( void ){
}

void I_ReadScreen( byte* scr ){
	memcpy( scr, screen, sizeof( screen ) );
}

boolean M_WriteFile( char const* name, void* source, int length ){
	return false;
}

int M_ReadFile( char const* name, byte** buffer ){
	return 0;
}

void M_ScreenShot( void ){
}

void I_InitNetwork( void ){
	netgame = false;

	doomcom = (doomcom_t*)malloc( sizeof(doomcom_t) );
	memset( doomcom, 0, sizeof( *doomcom ) );
	doomcom->ticdup        = 1;
	doomcom->extratics     = 0;
	doomcom->id            = DOOMCOM_ID;
	doomcom->numplayers    = 1;
	doomcom->numnodes      = 1;
	doomcom->deathmatch    = false;
	doomcom->consoleplayer = 0;
}

void I_NetCmd( void ){
	if( doomcom->command == CMD_GET ) {
		doomcom->remotenode = -1;
	}
}

void doom_init( char* shareDir, char* dataDir ){
	setenv( "DOOMWADDIR", shareDir, 1 );
	setenv( "HOME",       dataDir,  1 );
}

void doom_press( char keycode, int duration  ){
	if( duration < 0 ){
		duration = 0;
	}
	
	if( duration > 255 ){
		duration = 255;
	}

	switch(keycode){
	case 'a':
	case 'A':
		keyPressed[0] = duration;
		break;
	case 'd':
	case 'D':
		keyPressed[1] = duration;
		break;
	case 'w':
	case 'W':
		keyPressed[2] = duration;
		break;
	case 's':
	case 'S':
		keyPressed[3] = duration;
		break;
	case 'f':
	case 'F':
	case ' ':
		keyPressed[4] = duration;
		break;
	case 'e':
	case 'E':
		keyPressed[5] = duration;
		break;
	}
}

char* doom_get_screen( int width, int height ){
	if( width > 320 || height > 200 || width <= 0 || height <= 0 ){
		return strdup("invalid screen side");
	}

	char* text = malloc( (width*32+1) * height + 1);
	char* textPos = text;

	for(int row=0 ; row < height; row++){
		for(int col=0 ; col < width; col++){
			int x = col * WIDTH / width;
			int y = row * HEIGHT / height;

			char* symb = palette[ screen[x + y*WIDTH] ];
			strcpy( textPos, symb ? symb : " " );
			textPos += strlen(textPos);
		}

		*(textPos++) = 0;
	}
	
	*(textPos++) = 0;
	return text;
}

void doom_main( ){
	char* args[]={ "-skill", "1", "-episode", "1" };
	myargc = 4;
	myargv = args;
	D_DoomMain( );
}
